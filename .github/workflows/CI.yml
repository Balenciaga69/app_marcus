name: CI/CD Pipeline # CI/CD 流程名稱

on:
  push:
    branches: [ main, develop ] # 只要 push 到 main 或 develop 分支就觸發
  pull_request:
    branches: [ main, develop ] # 只要 PR 到 main 或 develop 分支就觸發

permissions:
  contents: read # 只允許讀取內容權限

jobs:
  backend-test:
    name: Backend Tests # 後端測試工作
    runs-on: ubuntu-latest # 在最新版 Ubuntu runner 上執行

    strategy:
      matrix:
        node-version: [20.x] # 可指定多個 Node.js 版本，這裡只用 20.x

    steps:
    - uses: actions/checkout@v4 # 取得原始碼

    - name: Setup Node.js ${{ matrix.node-version }} # 安裝指定 Node.js 版本
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm' # 啟用 pnpm 快取
        cache-dependency-path: backend/pnpm-lock.yaml # 依賴快取路徑

    - name: Install pnpm # 安裝 pnpm
      run: npm install -g pnpm

    - name: Install dependencies # 安裝後端依賴
      working-directory: ./backend
      run: pnpm install

    - name: Lint # 執行程式碼檢查
      working-directory: ./backend
      run: npm run lint

    - name: Run tests # 執行單元測試
      working-directory: ./backend
      run: npm test

    - name: Build # 編譯後端程式
      working-directory: ./backend
      run: npm run build

  # Uncomment when frontend is implemented
  # frontend-test:
  #   name: Frontend Tests # 前端測試工作
  #   runs-on: ubuntu-latest
  #   
  #   strategy:
  #     matrix:
  #       node-version: [20.x]
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Setup Node.js ${{ matrix.node-version }} # 安裝指定 Node.js 版本
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ matrix.node-version }}
  #       cache: 'npm'
  #       cache-dependency-path: frontend/package-lock.json
  #   
  #   - name: Install dependencies # 安裝前端依賴
  #     working-directory: ./frontend
  #     run: npm ci
  #   
  #   - name: Lint # 執行程式碼檢查
  #     working-directory: ./frontend
  #     run: npm run lint
  #   
  #   - name: Run tests # 執行單元測試
  #     working-directory: ./frontend
  #     run: npm test
  #   
  #   - name: Build # 編譯前端程式
  #     working-directory: ./frontend
  #     run: npm run build